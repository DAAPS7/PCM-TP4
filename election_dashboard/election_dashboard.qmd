---
title: "Eleições Legislativas 2025"
format: 
  dashboard:
    orientation: columns
    scrolling: true
    page-layout: none
---

```{ojs}
data = FileAttachment("data/ContinenteDistritos_geo.geojson").json()
tbl = FileAttachment("data/Legislativas1.json").json()

html `<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />`

function getPartyColors() { 
  return { 
    "PS": "#ff0000", 
    "PPD/PSD.CDS-PP": "#ff9900", 
    "CH": "#0000ff", 
    "IL": "#00ffff", 
    "B.E.": "#ff00ff", 
    "PCP-PEV": "#008000", 
    "L": "#800080", 
    "PAN": "#00ff00" 
  }; 
}

function partyVotesByDistrict(partido) {
  const result = [];
  const dadosPartido = tbl[partido];

  for (const [Distrito, Votos] of Object.entries(dadosPartido)) {
    result.push({ Distrito, Votos });
  }

  return result.sort((a, b) => b.votos - a.votos);
}

function votosPorDistrito(distritoNome) {
  const result = [];

  for (const [partido, distritos] of Object.entries(tbl)) {
    if (partido !== "Inscritos" && partido !== "Votantes" && partido !== "Abstenção" && partido !== "Brancos" && partido !== "Nulos" && partido !== "Votos Val. Exp. (VVE)"
    ) {
      const votos = distritos[distritoNome];
      if (votos !== undefined) {
        result.push({ partido, votos });
      }
    }
  }

  return result.sort((a, b) => b.votos - a.votos);
}

function toTitleCase(str) {
  return str.toLowerCase().split(' ').map(word => {
    if(word !== "do")
      return word.charAt(0).toUpperCase() + word.slice(1);
    else
      return word;
  }).join(' ');
}

mutable selectedDistrito = "Aveiro";

mapDiv = html `<div style="height: 400px;"></div>`

map = L.map(mapDiv, {
  zoomControl: true,
  dragging: true,
  scrollWheelZoom: true
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); 

distritos = L.geoJSON(data, {
  style: (feat) => { 
    const distrito = toTitleCase(feat.properties?.Distrito);
    const vencedor = votosPorDistrito(distrito)[0]?.partido;

    return { 
      fillColor: getPartyColors()[vencedor] || "#b3afafab", 
      fillOpacity: 0.7 
    }; 
  },
  onEachFeature: (feat, layer) => {
    layer.bindTooltip(toTitleCase(feat.properties?.Distrito),
    { sticky: true });
    layer.on("click", () => { 
      mutable selectedDistrito = toTitleCase(feat.properties?.Distrito); 
    }); 
  }
}).addTo(map);

map.fitBounds(distritos.getBounds());

mapDiv;
```

```{ojs}

Inputs.table(votosPorDistrito(selectedDistrito), { columns: ["partido", "votos"] });

function getPartidos() {
  return Object.keys(tbl).filter(partido => 
    partido !== "Inscritos" && partido !== "Votantes" && partido !== "Abstenção" && partido !== "Brancos" && partido !== "Nulos" && partido !== "Votos Val. Exp. (VVE)"
  );
}

viewof selectedPartido = Inputs.select(getPartidos(), {
  label: "Selecionar Partido"
});

Plot.plot({
  title: `Votos por Distrito para o partido: ${selectedPartido}`,
  marks: [
    Plot.barY(partyVotesByDistrict(selectedPartido), {
      x: "Distrito",
      y: "Votos",
    }),
  ],
  width: 1200,
  height: 700
})
```